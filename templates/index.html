<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Portal - Send Files to Buyer</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8fafc; }
        .container { max-width: 1400px; margin-top: 60px; }
        .card { box-shadow: 0 4px 24px rgba(0,0,0,0.08); min-width: 900px; }
        .file-list { max-height: 350px; overflow-y: auto; }
        @media (max-width: 991px) {
            .container, .card { min-width: unset; max-width: 98vw; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card p-4">
        <h2 class="mb-4 text-center">ü§ù Supplier Portal</h2>
        <p class="text-center text-muted mb-4">Upload your documents (PDF, Excel, Images) to send them securely to your buyer. You can also extract data from your files before sending.</p>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="alert alert-info">
              {{ messages[0] }}
            </div>
          {% endif %}
        {% endwith %}
        <form method="post" enctype="multipart/form-data" class="mb-4">
            <div class="input-group">
                    <input type="file" class="form-control" id="file" name="file" accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.json" required>
                <button class="btn btn-primary" type="submit">Upload File</button>
            </div>
        </form>
        <h5>Files Ready to Send</h5>
        <ul class="list-group file-list mb-2">
            {% for file in files %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ file }}</span>
                <div class="btn-group" role="group">
                    {% set ext = file.rsplit('.', 1)[1].lower() %}
                    {% if not file.endswith('.json') %}
                        <a href="{{ url_for('download_file', filename=file) }}" class="btn btn-sm btn-outline-success">Download</a>
                        {% set json_file = file + '.json' %}
                        {% if ext in ['jpg', 'png', 'pdf'] %}
                            {% if json_file in all_files %}
                                <button class="btn btn-sm btn-outline-info ms-2" onclick="extractData('{{ file }}', true)">View Extraction Data</button>
                                <button class="btn btn-sm btn-outline-warning ms-2" onclick="extractData('{{ file }}', false)">Refresh Extraction Data</button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="extractData('{{ file }}', false)">Extract Data</button>
                            {% endif %}
                        {% endif %}
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="showDeleteModal('{{ file }}')">Delete</button>
                    {% else %}
                        {# orphan .json file #}
                        <button class="btn btn-sm btn-outline-info ms-2" onclick="extractData('{{ file }}', true)">View JSON Data</button>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="showDeleteModal('{{ file }}')">Delete</button>
                    {% endif %}
                </div>
            </li>
            {% else %}
            <li class="list-group-item text-muted">No files uploaded yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">Confirm File Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-exclamation-triangle text-danger mb-3" viewBox="0 0 16 16">
                    <path d="M7.938 2.016a.13.13 0 0 1 .125 0l6.857 11.856c.06.104-.015.228-.125.228H1.205a.145.145 0 0 1-.125-.228L7.938 2.016zm.823-1.447a1.13 1.13 0 0 0-1.624 0L.28 12.425C-.457 13.566.345 15 1.606 15h12.788c1.26 0 2.063-1.434 1.325-2.575L8.76.57z"/>
                    <path d="M7.002 11a1 1 0 1 0 2 0 1 1 0 0 0-2 0zm.93-7.481a.5.5 0 0 1 .992 0l.35 6.002a.5.5 0 0 1-.992 0l-.35-6.002z"/>
                </svg>
                <div id="deleteModalText" class="mb-3">Are you sure you want to delete this file?</div>
                <form id="deleteForm" method="post" action="">
                    <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="extractModal" tabindex="-1" aria-labelledby="extractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="width:100%;">
            <div class="modal-header">
            <h5 class="modal-title" id="extractModalLabel">Data Extraction Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="extractModalBody">
            <div id="extractModalControls" class="mb-3" style="display:none;">
                <button id="toggleTableBtn" class="btn btn-outline-secondary btn-sm me-2" onclick="showTableView()">Table View</button>
                <button id="toggleJsonBtn" class="btn btn-outline-secondary btn-sm" onclick="showJsonView()">Raw JSON</button>
            </div>
            <div id="extractModalContent">Loading data from your file for the buyer...</div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let lastExtractedData = null;
let lastExtractedError = null;
let lastExtractedMode = 'table';
function extractData(filename, viewOnly) {
    const modal = new bootstrap.Modal(document.getElementById('extractModal'));
    document.getElementById('extractModalControls').style.display = 'none';
    document.getElementById('extractModalContent').innerHTML = 'Loading...';
    modal.show();
    fetch(`/extract/${filename}`, {method: viewOnly ? 'GET' : 'POST'})
        .then(r => r.json())
        .then(data => {
            lastExtractedData = data;
            lastExtractedError = data.error || null;
            if (data.error) {
                document.getElementById('extractModalControls').style.display = 'none';
                document.getElementById('extractModalContent').innerHTML = `<span class='text-danger'>${data.error}</span>`;
            } else {
                document.getElementById('extractModalControls').style.display = '';
                lastExtractedMode = 'table';
                showTableView();
            }
        })
        .catch(e => {
            document.getElementById('extractModalControls').style.display = 'none';
            document.getElementById('extractModalContent').innerHTML = `<span class='text-danger'>Error: ${e}</span>`;
        });
}

function showTableView() {
    if (lastExtractedError) {
        document.getElementById('extractModalContent').innerHTML = `<span class='text-danger'>${lastExtractedError}</span>`;
        return;
    }
    document.getElementById('toggleTableBtn').classList.add('active');
    document.getElementById('toggleJsonBtn').classList.remove('active');
    document.getElementById('extractModalContent').innerHTML = renderFancyTable(lastExtractedData);
    lastExtractedMode = 'table';
}

function showJsonView() {
    if (lastExtractedError) {
        document.getElementById('extractModalContent').innerHTML = `<span class='text-danger'>${lastExtractedError}</span>`;
        return;
    }
    document.getElementById('toggleTableBtn').classList.remove('active');
    document.getElementById('toggleJsonBtn').classList.add('active');
    document.getElementById('extractModalContent').innerHTML = `<pre style='max-height:60vh;overflow:auto;'>${escapeHtml(JSON.stringify(lastExtractedData, null, 2))}</pre>`;
    lastExtractedMode = 'json';
}

// Recursively render JSON as a fancy Bootstrap table
function renderFancyTable(obj, parentKey = '') {
    if (typeof obj !== 'object' || obj === null) {
        return `<span>${escapeHtml(obj)}</span>`;
    }
    if (Array.isArray(obj)) {
        let rows = obj.map((item, idx) => `<tr><th class='bg-light'>${parentKey}[${idx}]</th><td>${renderFancyTable(item, parentKey + '[' + idx + ']')}</td></tr>`).join('');
    return `<div class="table-responsive" style="width:100%;"><table class="table table-bordered table-striped align-middle w-100"><tbody>${rows}</tbody></table></div>`;
    }
    let rows = '';
    for (const key in obj) {
        if (Object.hasOwn(obj, key)) {
            const value = obj[key];
            if (typeof value === 'object' && value !== null) {
                rows += `<tr><th class='bg-light'>${parentKey ? parentKey + '.' : ''}${escapeHtml(key)}</th><td>${renderFancyTable(value, parentKey ? parentKey + '.' + key : key)}</td></tr>`;
            } else {
                rows += `<tr><th class='bg-light'>${parentKey ? parentKey + '.' : ''}${escapeHtml(key)}</th><td>${escapeHtml(value)}</td></tr>`;
            }
        }
    }
    return `<div class="table-responsive" style="width:100%;"><table class="table table-bordered table-striped align-middle w-100"><tbody>${rows}</tbody></table></div>`;
}

function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    return text.replace(/[&<>"']/g, function (c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
    });
}

let deleteModal = null;
function showDeleteModal(filename) {
    if (!deleteModal) {
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    }
    document.getElementById('deleteModalText').innerText = `Are you sure you want to delete "${filename}"?`;
    const form = document.getElementById('deleteForm');
    form.action = `/delete/${filename}`;
    deleteModal.show();
}
</script>
</body>
</html>
